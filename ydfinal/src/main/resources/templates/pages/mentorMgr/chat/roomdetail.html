<!doctype html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:v-bind="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout}">
<th:block layout:fragment="content">
	<!-- 상단 내비바 -->
	<th:block th:replace="fragments/navbar :: navbarFragment"></th:block>

	<head>

<style>
[v-cloak] {
	display: none;
}

.chat-box {
display: inline-block;
color: #fff;
margin: 0 0 30px 0;
}

.chat-box li {
display: table;
padding: 13px;
margin: 7px 10px;
font-size: 18px;
line-height: 25px;

-webkit-border-top-left-radius: 6px;
-webkit-border-top-right-radius: 6px;
-webkit-border-bottom-right-radius: 6px;
-webkit-border-bottom-left-radius: 6px;
-moz-border-radius-topleft: 6px;
-moz-border-radius-topright: 6px;
-moz-border-radius-bottomright: 6px;
-moz-border-radius-bottomleft: 6px;
border-top-left-radius: 6px;
border-top-right-radius: 6px;
border-bottom-right-radius: 6px;
border-bottom-left-radius: 6px;
}

.chat-box .you {
background-color: #343a40;
max-width: 60%;
clear: both;
float: left;
}

.chat-box .you:after {
content: ' ';
position: relative;
top: auto;
bottom: auto;
border: 12px solid;
border-color: transparent transparent #343a40 transparent;
margin: 0 0 0 -24px;
float: left;
}

.chat-box .me {
background-color: #6c757d;
max-width: 60%;
height: auto;
clear: both;
float: right;
}

.chat-box .me:after {
content: ' ';
position: relative;
bottom: auto;
border: 12px solid;
border-color: transparent transparent #6c757d transparent;
margin: 0 -24px 0 0;
float: right;
}


.chat-box li span {
padding: 0 0 5px;
color: #fff;
display: block;
font-weight:bold;
}


</style>
	</head>

	<body>
		<div>
			<button class="btn bg-gradient-secondary btn-sm" onclick="location.href=`/chat/room`">목록으로</button>
			<button class="btn bg-gradient-secondary btn-sm" type="button"  @click="endChat">상담종료</button>
		</div>
		<div class="container w-90" id="app" v-cloak>
			<div>
				<h2>{{room.roomName}}</h2>
			</div>
			<div>
				<input type="hidden" id="userId" v-model="userId" class="form-control" th:value="${#authentication.name}"> 
				<input type="hidden" id="userType" v-model="profstu" class="form-control"> 
				<input type="hidden" id="userName" v-model="name" class="form-control">
			</div>

			<div id="chatList" class="row w-95 justify-content-center" style="overflow: scroll; height: 550px;">
				<ul class="list-group chat-box">
					<li class="list-group-item" :class="{'me': message.sender == name , 'you': message.sender == null , 'body' : true  }" v-for="(message, idx) in messages.slice().reverse()" :key="idx">
						<span >{{message.sender}}</span> {{message.message}}
					</li>
				</ul>
			</div>


			<div class="p-4">
				<div class="input-group input-group-sm input-group-outline mb-4">
					<label >내용</label>
					<input type="text" ref="messages" v-model="message" v-on:keypress.enter="sendMessage">

					<button class="btn bg-gradient-secondary btn-sm" type="button" @click="sendMessage">보내기</button>
				</div>
			</div>
		</div>
		<!-- JavaScript -->
		<script src="https://cdn.jsdelivr.net/npm/vue-chat-scroll/dist/vue-chat-scroll.min.js"></script>
		<script src="/webjars/vue/2.5.16/dist/vue.min.js"></script>
		<script src="/webjars/axios/0.17.1/dist/axios.min.js"></script>
		<script src="/webjars/sockjs-client/1.1.2/sockjs.min.js"></script>
		<script src="/webjars/stomp-websocket/2.3.3-1/stomp.min.js"></script>
		<script>
		$(function() {
			 
		});
		
		
            //alert(document.title);
            // websocket & stomp initialize
            var sock = new SockJS("/ws/chat");
            //var sock = new SockJS("도메인주소/ws/chat");
            var ws = Stomp.over(sock);
            var reconnect = 0;
            // vue.js
            var vm = new Vue({
                el: '#app',
                data: {
                    roomId: '',
                    room: {},
                    sender: '',
                    message: '',
                    messages: [],
                    name : '',
                    userId : '',
                    profstu : ''

                },
                created() {
                    this.roomId = localStorage.getItem('wschat.roomId');
                    this.sender = localStorage.getItem('wschat.sender');
                    this.findRoom();
                    
                    axios.get('/userInfo').then(response => { 
    	            	console.log(response)
    	            	
    	            	this.name = response.data.userName;
    	            	this.userId = response.data.userId;
    	            	this.profstu = response.data.userTpye;
    	            	
                    
                    })
                    
                    var seId = $('#userId').val();
                    
                    
                    
                    $('li').addClass('you');
                    $('li[name='+seId+']').removeClass('you');
                    $('li[name='+seId+']').addClass('me');
                 
                    
                   
                },
                methods: {
                    findRoom: function () {
                        axios.get('/chat/room/' + this.roomId).then(response => { this.room = response.data; });
                    },
                    sendMessage: function () {
                    	if(this.message == ''){
                    		return;
                    	}
                        ws.send("/app/chat/message", {}, JSON.stringify({ type: 'TALK', roomId: this.roomId, sender: this.sender, message: this.message,profstu: this.profstu, name: this.name, userId: this.userId }));
                        this.message = '';
                    },
                    recvMessage: function (recv) {
                        this.messages.unshift({ "type": recv.type, "sender": recv.type == 'ENTER' ? '[알림]' : recv.sender, "message": recv.message })
                    },
                    endChat: function () {
                    	console.log(this.mtrId)
                    	 $.ajax({
         					url: "/mentoringUpdate2",
         					type: "post",
         					data : {},
         					success: function (result) {
         						console.log('성공')
         					},
         					error: function (result) {
         						console.log(result);
         					}
         				});  
                    },
                },
                watch: {
                    messages() {
                        // 화면에 추가된 후 동작하도록
                        this.$nextTick(() => {
                          
                            let messages = this.$refs.messages;
                            messages.scrollTo({top: messages.scrollHeight, behavior: 'smooth' });
                            $('#chatList').scrollTop($('#chatList')[0].scrollHeight);
                        });
                    },
                }
            });

            function connect() {
                // pub/sub event
                ws.connect({}, function (frame) {
                    ws.subscribe("/topic/chat/room/" + vm.$data.roomId, function (message) {
                        var recv = JSON.parse(message.body);
                        vm.recvMessage(recv);
                    });
                    ws.send("/app/chat/message", {}, JSON.stringify({ type: 'ENTER', roomId: vm.$data.roomId, sender: vm.$data.sender }));
                }, function (error) {
                    if (reconnect++ <= 5) {
                        setTimeout(function () {
                            console.log("connection reconnect");
                            sock = new SockJS("/ws/chat");
                            ws = Stomp.over(sock);
                            connect();
                        }, 10 * 1000);
                    }
                });
            }
            connect();
        </script>
</th:block>
</body>

</html>