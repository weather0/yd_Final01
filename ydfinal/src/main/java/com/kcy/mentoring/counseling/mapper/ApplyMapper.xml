<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kcy.mentoring.counseling.mapper.ApplyMapper">

	<select id="applySelectList" resultType="com.kcy.mentoring.counseling.vo.ApplyVO" parameterType="String">
		SELECT *
		FROM k_mentoring_schedule join k_sch_times on k_mentoring_schedule.mtr_sch_timecode = k_sch_times.mtr_sch_timecode
		where user_id = (SELECT prof_id
						 FROM k_matching
						 WHERE stu_id=#{id} AND matching_type = '0')
	</select>
	
	<select id="applyCheck" resultType="String" parameterType="String">
		SELECT IFNULL(mtr_status,'xxx') as mtr_status
		FROM k_mentoring 
		RIGHT OUTER JOIN (SELECT '') AS m_dual
		ON mtr_count =  (SELECT max(mtr_count) FROM k_mentoring)
 				   			AND matching_id=(SELECT matching_id
			       			FROM k_matching
			      			WHERE stu_id=#{id} AND matching_type = '0')
	</select>
	
	<select id="applySelect" resultType="com.kcy.mentoring.counseling.vo.ApplyVO" parameterType="String">
		SELECT career_q_id, career_q_content, career_list_id, career_q_yn
		FROM k_career_q
		WHERE career_q_yn='Y' AND career_list_id=(SELECT career_list_id
										  FROM k_career_list
									      WHERE prof_id=(SELECT IFNULL(prof_id,'xxx') as prof_id
													     FROM k_matching
													     WHERE stu_id=#{userId} AND matching_type = '0'))
	</select>
	
	<insert id="applyInsert" parameterType="com.kcy.mentoring.counseling.vo.ApplyVO">
		INSERT INTO k_career_d(career_h_id, career_q_result, career_q_id)
		VALUES((select MAX(career_h_id) from k_career_h where stu_id = #{userId}),#{careerQResult}, #{careerQId})
	</insert>
	
	<insert id="applyListInsert" parameterType="String">
		INSERT INTO k_career_h(career_h_id, stu_id, career_h_date)
		VALUES(nextval(sq_career_h_id),#{userId}, default)

	</insert>
	
	<insert id="applyHistoryInsert" parameterType="String">
		INSERT INTO k_mentoring(matching_id, mtr_count, mtr_status, mtr_id, mtr_sch_id, mtr_cancel, mtr_fileName,prof_id)
		VALUES((SELECT matching_id
				FROM k_matching
				WHERE stu_id=#{userId} 
				AND matching_type ='0'),(select IFNULL(MAX(mtr_count)+1,0)
										 from k_mentoring ALIAS_FOR_SUBQUERY
										 where matching_id = (SELECT matching_id
															  FROM k_matching
															  WHERE stu_id=#{userId} 
															  AND matching_type ='0')), default, nextval(sq_mtr_id), #{mtrSchId}, default, default,#{profId});
	</insert>
	
	<delete id="applyDelete" parameterType="com.kcy.mentoring.counseling.vo.ApplyVO">
		<!-- 없음 -->
	</delete>
	
	<select id="applyList" resultType="com.kcy.mentoring.counseling.vo.ApplyVO" parameterType="String">
		SELECT
  me.matching_id,
  me.mtr_count,
  me.mtr_status,
  me.mtr_sch_id,
  me.mtr_cancel,
  me.prof_id,
  ku.user_name,
  sc.mtr_sch_date,
  ti.mtr_sch_start,
  ti.mtr_sch_end
FROM
  k_users ku
  join k_matching ma on ku.user_id = ma.stu_id
  join k_mentoring me on ma.matching_id = me.matching_id
  join k_mentoring_schedule sc on me.mtr_sch_id = sc.mtr_sch_id
  join k_sch_times ti on sc.mtr_sch_timecode = ti.mtr_sch_timecode
where
  ma.prof_id = #{id}
  AND me.mtr_status = 'ing'
	</select>
</mapper>